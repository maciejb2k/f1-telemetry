<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Race Engineer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div class="flex h-screen">
      <!-- Telemetry -->
      <div class="w-1/2 p-4 overflow-y-auto">
        <h1 class="text-xl font-bold mb-4">Live Telemetry</h1>
        <table class="table-auto w-full text-sm">
          <thead>
            <tr class="bg-gray-200">
              <th class="px-2 py-1 text-left">Metric</th>
              <th class="px-2 py-1 text-left">Value</th>
              <th class="px-2 py-1 text-left">Updated At</th>
            </tr>
          </thead>
          <tbody id="telemetry"></tbody>
        </table>
      </div>

      <!-- Alerts -->
      <div class="w-1/2 p-4 overflow-y-auto border-l border-gray-300">
        <h1 class="text-xl font-bold mb-4">Active Alerts</h1>
        <div id="alerts" class="space-y-2 mb-8"></div>

        <h2 class="text-lg font-semibold mb-2">Alert History</h2>
        <div id="history" class="space-y-2"></div>
      </div>
    </div>

    <script>
      const previousValues = {};

      function severityColor(severity) {
        switch (severity) {
          case "critical":
            return "bg-red-100 border-red-500";
          case "warning":
            return "bg-yellow-100 border-yellow-500";
          case "info":
            return "bg-blue-100 border-blue-500";
          default:
            return "bg-gray-100 border-gray-400";
        }
      }

      async function fetchAlerts() {
        try {
          const response = await fetch(
            "http://localhost:8080/alerts/alerts/active"
          );
          const alerts = await response.json();

          const container = document.getElementById("alerts");
          container.innerHTML = "";

          if (alerts.length === 0) {
            container.innerHTML =
              "<p class='text-gray-500'>No active alerts</p>";
          } else {
            alerts.forEach((alert) => {
              const div = document.createElement("div");
              div.className = `p-2 border-l-4 ${severityColor(
                alert.severity
              )} rounded shadow-sm`;
              div.innerHTML = `
                <strong>${alert.metric}</strong>: ${alert.last_value} (${
                alert.operator
              } ${alert.threshold})<br>
                <span class="text-xs">Severity: ${
                  alert.severity
                }, Since: ${new Date(
                alert.opened_at
              ).toLocaleTimeString()}</span>
              `;
              container.appendChild(div);
            });
          }
        } catch (error) {
          console.error("Error fetching alerts:", error);
        }
      }

      async function fetchHistory() {
        try {
          const response = await fetch(
            "http://localhost:8080/alerts/alerts/history?since=2025-04-27T00:00:00Z"
          );
          const alerts = await response.json();

          const container = document.getElementById("history");
          container.innerHTML = "";

          if (alerts.length === 0) {
            container.innerHTML =
              "<p class='text-gray-500'>No alert history</p>";
          } else {
            alerts.forEach((alert) => {
              const div = document.createElement("div");
              div.className = `p-2 bg-gray-100 border border-gray-300 rounded text-sm text-gray-700`;
              div.innerHTML = `
                <strong>${alert.metric}</strong>: ${alert.last_value} (${
                alert.operator
              } ${alert.threshold})<br>
                <span class="text-xs text-gray-500">Severity: ${
                  alert.severity
                }, Opened: ${new Date(
                alert.opened_at
              ).toLocaleTimeString()}, Closed: ${
                alert.closed_at
                  ? new Date(alert.closed_at).toLocaleTimeString()
                  : "active"
              }</span>
              `;
              container.appendChild(div);
            });
          }
        } catch (error) {
          console.error("Error fetching history:", error);
        }
      }

      async function fetchTelemetry() {
        try {
          const response = await fetch(
            "http://localhost:8080/telemetry/cars/1/readings/latest"
          );
          const data = await response.json();
          const telemetryBody = document.getElementById("telemetry");
          telemetryBody.innerHTML = "";

          data.readings.forEach((reading) => {
            const metric = reading.metric;
            const value = reading.value;
            const prevValue = previousValues[metric];

            const tr = document.createElement("tr");
            tr.className =
              prevValue !== undefined && prevValue !== value
                ? "bg-yellow-100"
                : "";
            tr.innerHTML = `
              <td class="px-2 py-1">${metric}</td>
              <td class="px-2 py-1">${value}</td>
              <td class="px-2 py-1">${new Date(
                reading.updated_at
              ).toLocaleTimeString()}</td>
            `;

            telemetryBody.appendChild(tr);
            previousValues[metric] = value;
          });
        } catch (error) {
          console.error("Error fetching telemetry:", error);
        }
      }

      function updateDashboard() {
        fetchAlerts();
        fetchHistory();
        fetchTelemetry();
      }

      updateDashboard();
      setInterval(() => {
        updateDashboard();
      }, 1000);
    </script>
  </body>
</html>
