services:
  # ─── infra ────────────────────────────────────────────────

  gateway:
    image: traefik:v3.0
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.web.address=:80"
    ports: [ "8080:80", "8081:8080" ]
    volumes: [ "/var/run/docker.sock:/var/run/docker.sock:ro" ]

  rabbitmq:
    image: rabbitmq:3-management
    ports: [ "15672:15672" ]
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "status"]
      interval: 10s
      timeout: 10s
      retries: 5

  telemetry-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: telemetry }
    volumes: [ telemetry-data:/var/lib/postgresql/data ]

  rules-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: rules }
    volumes: [ rules-data:/var/lib/postgresql/data ]

  # alerts-db:
  #   image: postgres:16
  #   environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: alerts }

  # users-db:
  #   image: postgres:16
  #   environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: users }

  # ─── mikroserwisy ─────────────────────────────────────────

  telemetry:
    build: ./telemetry-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      telemetry-db:
        condition: service_started
    environment:
      DATABASE_URL: postgres://postgres:secret@telemetry-db:5432/telemetry
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      RAILS_ENV: development
    volumes: [ ./telemetry-service:/app ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telemetry.rule=PathPrefix(`/telemetry`)"
      - "traefik.http.routers.telemetry.entrypoints=web"
      - "traefik.http.services.telemetry.loadbalancer.server.port=3000"
    command: bash -c "rm -f tmp/pids/server.pid && bin/rails server -b '0.0.0.0'"

  rules:
    build: ./rules-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      rules-db:
        condition: service_started
    environment:
      DATABASE_URL: postgres://postgres:secret@rules-db:5432/rules
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      RAILS_ENV: development
    volumes:
      - ./rules-service:/app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.strategy-rules.rule=PathPrefix(`/rules`)"
      - "traefik.http.routers.strategy-rules.entrypoints=web"
      - "traefik.http.services.strategy-rules.loadbalancer.server.port=3000"
    command: bash -c "rm -f tmp/pids/server.pid && bin/rails server -b '0.0.0.0'"

  rules-subscriber:
    build: ./rules-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      rules-db:
        condition: service_started
    command: bundle exec rake rabbitmq:listen
    environment:
      DATABASE_URL: postgres://postgres:secret@rules-db:5432/rules
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      RAILS_ENV: development
    volumes:
      - ./rules-service:/app

volumes:
  telemetry-data:
  rules-data:
