services:
  # ─── infra ────────────────────────────────────────────────

  gateway:
    image: traefik:v3.0
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.web.address=:80"
    ports: [ "8080:80", "8081:8080" ]
    volumes: [ "/var/run/docker.sock:/var/run/docker.sock:ro" ]

  rabbitmq:
    image: rabbitmq:3-management
    ports: [ "15672:15672" ]
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "status"]
      interval: 3s
      timeout: 10s
      retries: 5

  telemetry-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: telemetry }
    volumes: [ telemetry-data:/var/lib/postgresql/data ]

  rules-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: rules }
    volumes: [ rules-data:/var/lib/postgresql/data ]

  alerts-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: alerts }
    volumes: [ alerts-data:/var/lib/postgresql/data ]

  # ─── mikroserwisy ─────────────────────────────────────────

  telemetry:
    build: ./telemetry-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      telemetry-db:
        condition: service_started
    environment:
      DATABASE_URL: postgres://postgres:secret@telemetry-db:5432/telemetry
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      RAILS_ENV: development
    volumes: [ ./telemetry-service:/app ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telemetry.rule=PathPrefix(`/telemetry`)"
      - "traefik.http.routers.telemetry.entrypoints=web"
      - "traefik.http.services.telemetry.loadbalancer.server.port=3000"
    stdin_open: true
    tty: true
    command: >
      bash -c "
        bin/rails db:create &&
        bin/rails db:migrate &&
        bin/rails db:schema:load &&
        bin/rails db:seed &&
        rm -f tmp/pids/server.pid &&
        bin/rails s -b '0.0.0.0'
      "

  rules:
    build: ./rules-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      rules-db:
        condition: service_started
      rules-redis:
        condition: service_started
    environment:
      DATABASE_URL: postgres://postgres:secret@rules-db:5432/rules
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      REDIS_URL: redis://rules-redis:6379/0
      RAILS_ENV: development
    volumes:
      - ./rules-service:/app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.strategy-rules.rule=PathPrefix(`/rules`)"
      - "traefik.http.routers.strategy-rules.entrypoints=web"
      - "traefik.http.services.strategy-rules.loadbalancer.server.port=3000"
    stdin_open: true
    tty: true
    command: >
      bash -c "
        bin/rails db:create &&
        bin/rails db:migrate &&
        bin/rails db:schema:load &&
        bin/rails db:seed &&
        rm -f tmp/pids/server.pid &&
        bin/rails s -b '0.0.0.0'
      "

  rules-subscriber:
    build: ./rules-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      rules-db:
        condition: service_started
      rules-redis:
        condition: service_started
    command: bundle exec rake rabbitmq:listen
    environment:
      DATABASE_URL: postgres://postgres:secret@rules-db:5432/rules
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      REDIS_URL: redis://rules-redis:6379/0
      RAILS_ENV: development
    volumes:
      - ./rules-service:/app

  rules-redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "900", "1", "--save", "300", "10"]

  alerts:
    build: ./alerts-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      alerts-db:
        condition: service_started
      alerts-redis:
        condition: service_started
    environment:
      DATABASE_URL: postgres://postgres:secret@alerts-db:5432/alerts
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      REDIS_URL: redis://alerts-redis:6379/0
      RAILS_ENV: development
    volumes: [ ./alerts-service:/app ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pit-alerts.rule=PathPrefix(`/alerts`)"
      - "traefik.http.routers.pit-alerts.entrypoints=web"
      - "traefik.http.services.pit-alerts.loadbalancer.server.port=3000"
    stdin_open: true
    tty: true
    command: >
      bash -c "
        bin/rails db:create &&
        bin/rails db:migrate &&
        bin/rails db:schema:load &&
        bin/rails db:seed &&
        rm -f tmp/pids/server.pid &&
        bin/rails s -b '0.0.0.0'
      "

  alerts-subscriber:
    build: ./alerts-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      alerts-db:
        condition: service_started
      alerts-redis:
        condition: service_started
    command: bundle exec rake rabbitmq:listen
    environment:
      DATABASE_URL: postgres://postgres:secret@alerts-db:5432/alerts
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      REDIS_URL: redis://alerts-redis:6379/0
      RAILS_ENV: development
    volumes: [ ./alerts-service:/app ]

  alerts-worker:
    build: ./alerts-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      alerts-db:
        condition: service_started
      alerts-redis:
        condition: service_started
    command: bundle exec rake alerts:worker
    environment:
      DATABASE_URL: postgres://postgres:secret@alerts-db:5432/alerts
      RABBIT_URL: amqp://guest:guest@rabbitmq:5672
      REDIS_URL: redis://alerts-redis:6379/0
      RAILS_ENV: development
    volumes: [ ./alerts-service:/app ]

  alerts-redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "900", "1", "--save", "300", "10"]

  # ─── frontend ─────────────────────────────────────────

  dashboard:
    image: nginx:alpine
    volumes:
      - ./dashboard-service:/usr/share/nginx/html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=PathPrefix(`/dashboard`)"
      - "traefik.http.routers.dashboard.middlewares=dashboard-stripprefix"
      - "traefik.http.middlewares.dashboard-stripprefix.stripprefix.prefixes=/dashboard"
      - "traefik.http.routers.dashboard.entrypoints=web"
      - "traefik.http.services.dashboard.loadbalancer.server.port=80"

  simulator:
    image: nginx:alpine
    volumes:
      - ./simulator-service:/usr/share/nginx/html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.simulator.rule=PathPrefix(`/simulator`)"
      - "traefik.http.routers.simulator.middlewares=simulator-stripprefix"
      - "traefik.http.middlewares.simulator-stripprefix.stripprefix.prefixes=/simulator"
      - "traefik.http.routers.simulator.entrypoints=web"
      - "traefik.http.services.simulator.loadbalancer.server.port=80"

volumes:
  telemetry-data:
  rules-data:
  alerts-data:
