services:
  # ─── infra ────────────────────────────────────────────────

  gateway:
    image: traefik:v3.0
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.web.address=:80"
    ports: [ "8080:80", "8081:8080" ]
    volumes: [ "/var/run/docker.sock:/var/run/docker.sock:ro" ]

  rabbitmq:
    image: rabbitmq:3-management
    ports: [ "15672:15672" ]
    healthcheck: { test: ["CMD", "rabbitmq-diagnostics", "-q", "status"], interval: 10s }

  telemetry-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: telemetry }
    volumes: [ telemetry-data:/var/lib/postgresql/data ]

  rules-db:
    image: postgres:16
    environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: rules }
    volumes: [ rules-data:/var/lib/postgresql/data ]

  # alerts-db:
  #   image: postgres:16
  #   environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: alerts }

  # users-db:
  #   image: postgres:16
  #   environment: { POSTGRES_PASSWORD: secret, POSTGRES_DB: users }

  # ─── mikroserwisy ─────────────────────────────────────────

  telemetry:
    build: ./telemetry-service
    environment:
      DATABASE_URL: postgres://postgres:secret@telemetry-db:5432/telemetry
      RABBIT_URL:   amqp://guest:guest@rabbitmq:5672
    volumes: [ ./telemetry-service:/app ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telemetry.rule=PathPrefix(`/telemetry`)"
      - "traefik.http.routers.telemetry.entrypoints=web"
      - "traefik.http.services.telemetry.loadbalancer.server.port=3000"

  strategy-rules:
    build: ./strategy-rules-service
    environment:
      DATABASE_URL: postgres://postgres:secret@rules-db:5432/rules
      RABBIT_URL:   amqp://guest:guest@rabbitmq:5672
    volumes:
      - ./strategy-rules:/app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.strategy-rules.rule=PathPrefix(`/rules`)"
      - "traefik.http.routers.strategy-rules.entrypoints=web"
      - "traefik.http.services.strategy-rules.loadbalancer.server.port=3000"

volumes:
  telemetry-data:
  rules-data:
  alerts-data:
